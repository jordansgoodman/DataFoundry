version: "3.9"

services:
  setup:
    image: alpine:3.20
    restart: "no"
    environment:
      DF_HOSTNAME: ${DF_HOSTNAME:-localhost}
      POSTGRES_DB: ${POSTGRES_DB:-datafoundry}
      POSTGRES_USER: ${POSTGRES_USER:-datafoundry}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
      AIRFLOW_ADMIN_USERNAME: ${AIRFLOW_ADMIN_USERNAME:-airflow}
      AIRFLOW_ADMIN_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD:-airflow123}
      AIRFLOW_ADMIN_EMAIL: ${AIRFLOW_ADMIN_EMAIL:-airflow@datafoundry.local}
      SUPERSET_ADMIN_USERNAME: ${SUPERSET_ADMIN_USERNAME:-superset}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-superset123}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-superset@datafoundry.local}
      GRAFANA_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GRAFANA_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin123}
      PGADMIN_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_PASSWORD: ${PGADMIN_PASSWORD:-pgadmin123}
    volumes:
      - ./data:/data
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        mkdir -p \
          /data/airflow \
          /data/airflow/.dlt \
          /data/postgres \
          /data/pgadmin \
          /data/superset \
          /data/logging/loki \
          /data/logging/promtail \
          /data/logging/grafana
        chmod -R a+rwX /data || true
        if [ ! -f /data/pgadmin/servers.json ]; then
          cat > /data/pgadmin/servers.json <<JSON
        {
          "Servers": {
            "1": {
              "Name": "DataSpec Postgres",
              "Group": "Servers",
              "Host": "postgres",
              "Port": 5432,
              "MaintenanceDB": "${POSTGRES_DB:-datafoundry}",
              "Username": "${POSTGRES_USER:-datafoundry}",
              "SSLMode": "prefer"
            }
          }
        }
        JSON
        fi
        if [ ! -f /data/pgadmin/pgpass ]; then
          cat > /data/pgadmin/pgpass <<PGPASS
        postgres:5432:${POSTGRES_DB:-datafoundry}:${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}
        PGPASS
          chmod 600 /data/pgadmin/pgpass
        fi
        cat > /data/credentials.txt <<CREDS
        DataSpec Credentials (auto-generated)
        ========================================
        DF_HOSTNAME=${DF_HOSTNAME:-localhost}

        Postgres user: ${POSTGRES_USER:-datafoundry}
        Postgres password: ${POSTGRES_PASSWORD:-datafoundry}
        Postgres database: ${POSTGRES_DB:-datafoundry}

        Airflow admin: ${AIRFLOW_ADMIN_USERNAME:-airflow}
        Airflow password: ${AIRFLOW_ADMIN_PASSWORD:-airflow123}

        Superset admin: ${SUPERSET_ADMIN_USERNAME:-superset}
        Superset password: ${SUPERSET_ADMIN_PASSWORD:-superset123}

        Grafana admin: ${GRAFANA_ADMIN_USER:-admin}
        Grafana password: ${GRAFANA_ADMIN_PASSWORD:-admin123}

        pgAdmin email: ${PGADMIN_EMAIL:-admin@example.com}
        pgAdmin password: ${PGADMIN_PASSWORD:-pgadmin123}
        CREDS
        chmod 600 /data/credentials.txt || true
    networks: [df]

  postgres:
    image: postgres:15
    restart: unless-stopped
    depends_on:
      setup:
        condition: service_completed_successfully
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-datafoundry}
      POSTGRES_USER: ${POSTGRES_USER:-datafoundry}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
      AIRFLOW_DB: ${AIRFLOW_DB:-airflow}
      SUPERSET_DB: ${SUPERSET_DB:-superset}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/db/init.sh:/docker-entrypoint-initdb.d/01_init.sh:ro
    ports:
      - "5432:5432"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-datafoundry} -d ${POSTGRES_DB:-datafoundry}"]
      interval: 10s
      timeout: 5s
      retries: 10

  airflow-webserver:
    build:
      context: ./docker/airflow
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    user: "${AIRFLOW_UID:-50000}:0"
    environment:
      HOME: /opt/airflow
      DLT_HOME: /opt/airflow/.dlt
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW__CORE__FERNET_KEY:-9d0pXJ0nQ0M0r3xLw2QXxk8H9S3jY2y7jZr6jv7b6b4=}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}@postgres:5432/${AIRFLOW_DB:-airflow}
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
      AIRFLOW__WEBSERVER__BASE_URL: ${AIRFLOW__WEBSERVER__BASE_URL:-http://localhost:8080}
      AIRFLOW__WEBSERVER__WEB_SERVER_URL_PREFIX: ""
      AIRFLOW__WEBSERVER__WEB_SERVER_HOST: 0.0.0.0
      AIRFLOW__WEBSERVER__WEB_SERVER_PORT: "8080"
      AIRFLOW_ADMIN_USERNAME: ${AIRFLOW_ADMIN_USERNAME:-airflow}
      AIRFLOW_ADMIN_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD:-airflow123}
      AIRFLOW_ADMIN_EMAIL: ${AIRFLOW_ADMIN_EMAIL:-airflow@datafoundry.local}
      DESTINATION__POSTGRES__CREDENTIALS__HOST: postgres
      DESTINATION__POSTGRES__CREDENTIALS__PORT: 5432
      DESTINATION__POSTGRES__CREDENTIALS__DATABASE: ${POSTGRES_DB:-datafoundry}
      DESTINATION__POSTGRES__CREDENTIALS__USERNAME: ${POSTGRES_USER:-datafoundry}
      DESTINATION__POSTGRES__CREDENTIALS__PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
      AIRFLOW_VAR_DLT_SECRETS_TOML: |
        [destination.postgres.credentials]
        host = "postgres"
        port = 5432
        database = "${POSTGRES_DB:-datafoundry}"
        username = "${POSTGRES_USER:-datafoundry}"
        password = "${POSTGRES_PASSWORD:-datafoundry}"
      NYC_TAXI_URL: ${NYC_TAXI_URL:-https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2023-01.parquet}
    volumes:
      - ./data/airflow:/opt/airflow
      - ./scripts/airflow/airflow.cfg:/opt/airflow/airflow.cfg:ro
      - ./airflow/dags:/opt/airflow/dags:ro
    command: ["bash", "-c", "airflow db init && airflow users create --username ${AIRFLOW_ADMIN_USERNAME:-airflow} --password ${AIRFLOW_ADMIN_PASSWORD:-airflow123} --firstname Admin --lastname User --role Admin --email ${AIRFLOW_ADMIN_EMAIL:-airflow@datafoundry.local} || true && airflow webserver"]
    ports:
      - "8080:8080"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport sys, urllib.request\ntry:\n  urllib.request.urlopen('http://localhost:8080/health', timeout=5)\n  sys.exit(0)\nexcept Exception:\n  sys.exit(1)\nPY"]
      interval: 20s
      timeout: 5s
      retries: 10

  airflow-scheduler:
    build:
      context: ./docker/airflow
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    user: "${AIRFLOW_UID:-50000}:0"
    environment:
      HOME: /opt/airflow
      DLT_HOME: /opt/airflow/.dlt
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW__CORE__FERNET_KEY:-9d0pXJ0nQ0M0r3xLw2QXxk8H9S3jY2y7jZr6jv7b6b4=}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}@postgres:5432/${AIRFLOW_DB:-airflow}
      DESTINATION__POSTGRES__CREDENTIALS__HOST: postgres
      DESTINATION__POSTGRES__CREDENTIALS__PORT: 5432
      DESTINATION__POSTGRES__CREDENTIALS__DATABASE: ${POSTGRES_DB:-datafoundry}
      DESTINATION__POSTGRES__CREDENTIALS__USERNAME: ${POSTGRES_USER:-datafoundry}
      DESTINATION__POSTGRES__CREDENTIALS__PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
      AIRFLOW_VAR_DLT_SECRETS_TOML: |
        [destination.postgres.credentials]
        host = "postgres"
        port = 5432
        database = "${POSTGRES_DB:-datafoundry}"
        username = "${POSTGRES_USER:-datafoundry}"
        password = "${POSTGRES_PASSWORD:-datafoundry}"
      NYC_TAXI_URL: ${NYC_TAXI_URL:-https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2023-01.parquet}
    volumes:
      - ./data/airflow:/opt/airflow
      - ./airflow/dags:/opt/airflow/dags:ro
    command: ["bash", "-c", "airflow scheduler"]
    networks: [df]

  airflow-trigger:
    build:
      context: ./docker/airflow
      dockerfile: Dockerfile
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    user: "${AIRFLOW_UID:-50000}:0"
    environment:
      HOME: /opt/airflow
      DLT_HOME: /opt/airflow/.dlt
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW__CORE__FERNET_KEY:-9d0pXJ0nQ0M0r3xLw2QXxk8H9S3jY2y7jZr6jv7b6b4=}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}@postgres:5432/${AIRFLOW_DB:-airflow}
      NYC_TAXI_URL: ${NYC_TAXI_URL:-https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2023-01.parquet}
    volumes:
      - ./data/airflow:/opt/airflow
      - ./airflow/dags:/opt/airflow/dags:ro
    command:
      - bash
      - -c
      - |
        set -euo pipefail
        if [ ! -f /opt/airflow/.airflow_initialized ]; then
          airflow dags unpause nyc_taxi_full_refresh || true
          airflow dags trigger nyc_taxi_full_refresh || true
          touch /opt/airflow/.airflow_initialized
        fi
    networks: [df]

  superset:
    image: apache/superset:2.1.0
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SUPERSET_HOME: /app/superset_home
      SUPERSET_LOAD_EXAMPLES: "no"
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY:-superset-secret}
      SUPERSET_SQLALCHEMY_DATABASE_URI: postgresql+psycopg2://${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}@postgres:5432/${SUPERSET_DB:-superset}
      SUPERSET_ADMIN_USERNAME: ${SUPERSET_ADMIN_USERNAME:-superset}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD:-superset123}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-superset@datafoundry.local}
    volumes:
      - ./data/superset:/app/superset_home
      - ./scripts/superset/superset_config.py:/app/pythonpath/superset_config.py:ro
    command:
      - bash
      - -c
      - |
        set -e
        superset db upgrade
        superset fab create-admin \
          --username "${SUPERSET_ADMIN_USERNAME:-superset}" \
          --password "${SUPERSET_ADMIN_PASSWORD:-superset123}" \
          --firstname Admin \
          --lastname User \
          --email "${SUPERSET_ADMIN_EMAIL:-superset@datafoundry.local}" || true
        superset init
        gunicorn --bind 0.0.0.0:8088 'superset.app:create_app()'
    ports:
      - "8088:8088"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8088/health >/dev/null || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10

  loki:
    image: grafana/loki:2.9.5
    restart: unless-stopped
    depends_on: {}
    volumes:
      - ./data/logging/loki:/loki
      - ./scripts/logging/loki-config.yml:/etc/loki/config.yml:ro
    command: ["-config.file=/etc/loki/config.yml"]
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3100/ready || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10

  promtail:
    image: grafana/promtail:2.9.5
    restart: unless-stopped
    depends_on: {}
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./data/logging/promtail:/promtail
      - ./scripts/logging/promtail-config.yml:/etc/promtail/config.yml:ro
    command: ["-config.file=/etc/promtail/config.yml"]
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9080/ready || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10

  grafana:
    image: grafana/grafana:10.4.3
    restart: unless-stopped
    depends_on: {}
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin123}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - ./data/logging/grafana:/var/lib/grafana
      - ./scripts/logging/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    ports:
      - "3001:3000"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/api/health >/dev/null || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10

  dlt:
    image: ghcr.io/dlt-hub/dlt:1.6.0
    profiles: ["tools"]
    environment:
      DLT_LOG_LEVEL: INFO
      DLT_DB_DESTINATION: postgres
      DESTINATION__POSTGRES__CREDENTIALS__HOST: postgres
      DESTINATION__POSTGRES__CREDENTIALS__PORT: 5432
      DESTINATION__POSTGRES__CREDENTIALS__DATABASE: ${POSTGRES_DB:-datafoundry}
      DESTINATION__POSTGRES__CREDENTIALS__USERNAME: ${POSTGRES_USER:-datafoundry}
      DESTINATION__POSTGRES__CREDENTIALS__PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
    volumes:
      - ./scripts/dlt:/app
    command: ["bash", "-c", "sleep infinity"]
    networks: [df]

  pgadmin:
    image: dpage/pgadmin4:8.12
    restart: unless-stopped
    depends_on:
      setup:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-pgadmin123}
      PGADMIN_LISTEN_PORT: 5050
    volumes:
      - ./data/pgadmin:/var/lib/pgadmin
      - ./data/pgadmin/servers.json:/pgadmin4/servers.json:ro
      - ./data/pgadmin/pgpass:/var/lib/pgadmin/pgpass:ro
    ports:
      - "5050:5050"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5050/ >/dev/null || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10

networks:
  df: {}
