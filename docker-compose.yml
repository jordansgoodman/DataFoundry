version: "3.9"

services:
  setup:
    image: alpine:3.20
    restart: "no"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-datafoundry}
      POSTGRES_USER: ${POSTGRES_USER:-datafoundry}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
    volumes:
      - ./data:/data
    command:
      - /bin/sh
      - -c
      - |
        set -eu
        mkdir -p \
          /data/airflow \
          /data/postgres \
          /data/pgadmin
        chmod -R a+rwX /data || true
        if [ ! -f /data/pgadmin/servers.json ]; then
          cat > /data/pgadmin/servers.json <<JSON
        {
          "Servers": {
            "1": {
              "Name": "DataFoundry Postgres",
              "Group": "Servers",
              "Host": "postgres",
              "Port": 5432,
              "MaintenanceDB": "${POSTGRES_DB:-datafoundry}",
              "Username": "${POSTGRES_USER:-datafoundry}",
              "SSLMode": "prefer"
            }
          }
        }
        JSON
        fi
        if [ ! -f /data/pgadmin/pgpass ]; then
          cat > /data/pgadmin/pgpass <<PGPASS
        postgres:5432:${POSTGRES_DB:-datafoundry}:${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}
        PGPASS
          chmod 600 /data/pgadmin/pgpass
        fi
    networks: [df]

  postgres:
    image: postgres:15
    restart: unless-stopped
    depends_on:
      setup:
        condition: service_completed_successfully
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-datafoundry}
      POSTGRES_USER: ${POSTGRES_USER:-datafoundry}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
      AIRFLOW_DB: ${AIRFLOW_DB:-airflow}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/db/init.sh:/docker-entrypoint-initdb.d/01_init.sh:ro
    ports:
      - "5432:5432"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-datafoundry} -d ${POSTGRES_DB:-datafoundry}"]
      interval: 10s
      timeout: 5s
      retries: 10

  airflow-webserver:
    build:
      context: ./docker/airflow
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      setup:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    user: "${AIRFLOW_UID:-50000}:0"
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW__CORE__FERNET_KEY:-9d0pXJ0nQ0M0r3xLw2QXxk8H9S3jY2y7jZr6jv7b6b4=}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}@postgres:5432/${AIRFLOW_DB:-airflow}
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
      AIRFLOW__WEBSERVER__BASE_URL: ${AIRFLOW__WEBSERVER__BASE_URL:-http://localhost:8080}
      AIRFLOW__WEBSERVER__WEB_SERVER_URL_PREFIX: ""
      AIRFLOW__WEBSERVER__WEB_SERVER_HOST: 0.0.0.0
      AIRFLOW__WEBSERVER__WEB_SERVER_PORT: "8080"
      AIRFLOW_ADMIN_USERNAME: ${AIRFLOW_ADMIN_USERNAME:-airflow}
      AIRFLOW_ADMIN_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD:-airflow123}
      AIRFLOW_ADMIN_EMAIL: ${AIRFLOW_ADMIN_EMAIL:-airflow@datafoundry.local}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__HOST: postgres
      DLT_DESTINATION_POSTGRES_CREDENTIALS__PORT: 5432
      DLT_DESTINATION_POSTGRES_CREDENTIALS__DATABASE: ${POSTGRES_DB:-datafoundry}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__USERNAME: ${POSTGRES_USER:-datafoundry}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
      NYC_TAXI_URL: ${NYC_TAXI_URL:-https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2023-01.parquet}
    volumes:
      - ./data/airflow:/opt/airflow
      - ./scripts/airflow/airflow.cfg:/opt/airflow/airflow.cfg:ro
      - ./airflow/dags:/opt/airflow/dags:ro
    command: ["bash", "-c", "airflow db init && airflow users create --username ${AIRFLOW_ADMIN_USERNAME:-airflow} --password ${AIRFLOW_ADMIN_PASSWORD:-airflow123} --firstname Admin --lastname User --role Admin --email ${AIRFLOW_ADMIN_EMAIL:-airflow@datafoundry.local} || true && airflow webserver"]
    ports:
      - "8080:8080"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport sys, urllib.request\ntry:\n  urllib.request.urlopen('http://localhost:8080/health', timeout=5)\n  sys.exit(0)\nexcept Exception:\n  sys.exit(1)\nPY"]
      interval: 20s
      timeout: 5s
      retries: 10

  airflow-scheduler:
    build:
      context: ./docker/airflow
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      setup:
        condition: service_completed_successfully
      airflow-webserver:
        condition: service_healthy
    user: "${AIRFLOW_UID:-50000}:0"
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW__CORE__FERNET_KEY:-9d0pXJ0nQ0M0r3xLw2QXxk8H9S3jY2y7jZr6jv7b6b4=}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}@postgres:5432/${AIRFLOW_DB:-airflow}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__HOST: postgres
      DLT_DESTINATION_POSTGRES_CREDENTIALS__PORT: 5432
      DLT_DESTINATION_POSTGRES_CREDENTIALS__DATABASE: ${POSTGRES_DB:-datafoundry}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__USERNAME: ${POSTGRES_USER:-datafoundry}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
      NYC_TAXI_URL: ${NYC_TAXI_URL:-https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2023-01.parquet}
    volumes:
      - ./data/airflow:/opt/airflow
      - ./airflow/dags:/opt/airflow/dags:ro
    command: ["bash", "-c", "airflow scheduler"]
    networks: [df]

  airflow-trigger:
    build:
      context: ./docker/airflow
      dockerfile: Dockerfile
    restart: "no"
    depends_on:
      airflow-webserver:
        condition: service_healthy
    user: "${AIRFLOW_UID:-50000}:0"
    environment:
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW__CORE__FERNET_KEY:-9d0pXJ0nQ0M0r3xLw2QXxk8H9S3jY2y7jZr6jv7b6b4=}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${POSTGRES_USER:-datafoundry}:${POSTGRES_PASSWORD:-datafoundry}@postgres:5432/${AIRFLOW_DB:-airflow}
      NYC_TAXI_URL: ${NYC_TAXI_URL:-https://d37ci6vzurychx.cloudfront.net/trip-data/yellow_tripdata_2023-01.parquet}
    volumes:
      - ./data/airflow:/opt/airflow
      - ./airflow/dags:/opt/airflow/dags:ro
    command:
      - bash
      - -c
      - |
        set -euo pipefail
        if [ ! -f /opt/airflow/.airflow_initialized ]; then
          airflow dags unpause nyc_taxi_full_refresh || true
          airflow dags trigger nyc_taxi_full_refresh || true
          touch /opt/airflow/.airflow_initialized
        fi
    networks: [df]

  dlt:
    image: ghcr.io/dlt-hub/dlt:1.6.0
    profiles: ["tools"]
    environment:
      DLT_LOG_LEVEL: INFO
      DLT_DB_DESTINATION: postgres
      DLT_DESTINATION_POSTGRES_CREDENTIALS__HOST: postgres
      DLT_DESTINATION_POSTGRES_CREDENTIALS__PORT: 5432
      DLT_DESTINATION_POSTGRES_CREDENTIALS__DATABASE: ${POSTGRES_DB:-datafoundry}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__USERNAME: ${POSTGRES_USER:-datafoundry}
      DLT_DESTINATION_POSTGRES_CREDENTIALS__PASSWORD: ${POSTGRES_PASSWORD:-datafoundry}
    volumes:
      - ./scripts/dlt:/app
    command: ["bash", "-c", "sleep infinity"]
    networks: [df]

  pgadmin:
    image: dpage/pgadmin4:8.12
    restart: unless-stopped
    depends_on:
      setup:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-pgadmin123}
      PGADMIN_LISTEN_PORT: 5050
    volumes:
      - ./data/pgadmin:/var/lib/pgadmin
      - ./data/pgadmin/servers.json:/pgadmin4/servers.json:ro
      - ./data/pgadmin/pgpass:/var/lib/pgadmin/pgpass:ro
    ports:
      - "5050:5050"
    networks: [df]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5050/ >/dev/null || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10

networks:
  df: {}
